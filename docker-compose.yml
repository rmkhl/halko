services:
  simulator:
    build:
      context: .
      dockerfile: simulator/Dockerfile
    volumes:
      - ./fsdb:/fsdb
      - ./halko-docker.cfg:/etc/halko/halko.cfg:ro
    ports:
      - "8088:8088"  # Shelly emulation interface
      - "8093:8093"  # SensorUnit emulation interface
    restart: unless-stopped

  controlunit:
    build:
      context: .
      dockerfile: controlunit/Dockerfile
    volumes:
      - ./fsdb:/fsdb
      - ./halko-docker.cfg:/etc/halko/halko.cfg:ro
    ports:
      - "8090:8090"
    depends_on:
      simulator:
        condition: service_started
    restart: unless-stopped

  powerunit:
    build:
      context: .
      dockerfile: powerunit/Dockerfile
    volumes:
      - ./halko-docker.cfg:/etc/halko/halko.cfg:ro
    ports:
      - "8092:8092"
    restart: unless-stopped

  storage:
    build:
      context: .
      dockerfile: storage/Dockerfile
    volumes:
      - ./fsdb:/fsdb
      - ./halko-docker.cfg:/etc/halko/halko.cfg:ro
    ports:
      - "8091:8091"
    restart: unless-stopped

  webapp:
    build:
      context: ./webapp
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    depends_on:
      - controlunit
      - storage
      - powerunit
    restart: unless-stopped
